<html lang="ja">
    <head>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
        <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    </head>
    <body>
        <header>
            <p>CodeTrain</p>
        </header>
        <div class="center">
            <div class="top-content">
                <h1 id="txt1"></h1>
                <p id="txt2"></p>
            </div>
            <div class="box_parent">
            <div class="box">
                <h3>入力される値</h3>
                <p id="txt3"></p>
            </div>
            <div class="box">
                <h3>期待する出力</h3>
                <p id="txt4"></p>
            </div>
            <div class="box">
                <h3>条件</h3>
                <p id="txt5"></p>
            </div>
            <div class="box">
                <h3>入力例</h3>
                <p id="txt6"></p>
            </div>
            <div class="box">
                <h3>出力例</h3>
                <p id="txt7"></p>
            </div>
            </div>
            <div class="kaitouran">
                <h3>解答コード入力欄</h3>
            <div class="editor_parent">
                <div class="editor_numbers" id="editor_numbers"></div>
                <textarea id="editor_input" rows="10000" class="editor_input"></textarea>
            </div>
            <div class="exe_line">
                <p>動作確認で使うテストケースを選択</p>
                <select id="testcase_select">
                    <option value="1">入力例1</option>
                    <option value="2">入力例2</option>
                </select>
                <button py-click="execute()" class="exeButton">提出前動作確認</button>
            </div>
            </div>
            <div class="result_parent" id="result_parent">
                <div class="result_top" id="res_top">
                    <p id="judge"></p>
                </div><!--

            --><div class="result_box">
                    <p class="message">提出前動作確認の入力値</p>
                    <p id="mess1"></p>
                </div><!--
                    
            --><div class="result_box">
                    <p class="message">期待する出力</p>
                    <p id="mess2"></p>
                </div><!--
                    
            --><div class="result_box" id="judge_backg">
                    <p class="message">あなたのコードの出力</p>
                    <p id="mess3"></p>
                </div>
            </div>
            <button class="exeButton2" py-click="teishutu()">提出</button>
        </div>
        <py-script>
            from js import print_to_output, getParam
            from pyodide.http import open_url
            import random
            import json
            url = "https://ryoichi2003910.github.io/CodeTrain/data.json"
            data = json.loads(open_url(url).read())
            
            id = int(getParam("id"))
            testcase = []
            algo_out = []
            i_out = []
            count = -1
            Element("editor_input").element.innerHTML = '# coding: utf-8\ninput_line = input()\nprint("XXXXXX")'

            def execute():
                global testcase, algo_out, i_out, count
                Element("result_parent").element.style.display = "block"
                num = Element("testcase_select").element.value
                testcase = data["questions"][id-1]["testcase" + str(num)]
                mess = ""
                for i in testcase:
                    mess += str(i)+"<br>"
                Element("mess1").element.innerHTML = mess
                exec("n=testcase\n" + data["questions"][id-1]["algorithm"])
                mess = ""
                for i in algo_out:
                    mess += str(i) + "<br>"
                Element("mess2").element.innerHTML = mess
                ev = Element("editor_input").element.value
                exec(print_to_output(ev))
                mess = ""
                for i in i_out:
                    mess += str(i) + "<br>"
                Element("mess3").element.innerHTML = mess
                if algo_out == i_out:
                    Element("res_top").element.style.backgroundColor = "skyblue"
                    Element("judge").element.innerHTML = "コード実行結果：○正解"
                    Element("judge_backg").element.style.backgroundColor = "#d6f5ff"
                else:
                    Element("res_top").element.style.backgroundColor = "orange"
                    Element("judge").element.innerHTML = "コード実行結果：×不正解"
                    Element("judge_backg").element.style.backgroundColor = "#f9eaef"
                algo_out = []
                i_out = []
                count = -1

            def random_n():
                return random.randint(data["questions"][id-1]["min"], data["questions"][id-1]["max"])

            def output(txt):
               i_out.append(txt)

            def algoPrint(txt):
                global algo_out
                algo_out.append(txt)

            def teishutu():
                pass
            
            def addTxt(n,txt):
                Element("txt"+str(n)).element.innerHTML = txt

            def input():
                global testcase, count
                count += 1
                return testcase[count]

            addTxt(1,data["questions"][id-1]["title"])
            addTxt(2,data["questions"][id-1]["question"])
            addTxt(3,data["questions"][id-1]["input"])
            addTxt(4,data["questions"][id-1]["kitai_output"])
            addTxt(5,data["questions"][id-1]["jouken"])
            addTxt(6,data["questions"][id-1]["input_rei"])
            addTxt(7,data["questions"][id-1]["output_rei"])

        </py-script>
        <style>
            body{
                margin:0;
                padding:0;
                background-color: whitesmoke;
            }
            header{
                width:100%;
                padding:2px;
                text-align: center;
                background-color: rgba(120, 164, 235, 0.644);
                box-shadow: 0px 10px 10px -6px rgba(0, 0, 0, 0.3);
                font-size: 1.2em;
                font-weight: 900;
            }
            .center{
                width: 60%;
                margin: 0 auto;
                padding:5%;
                word-break: break-all;
            }
            .editor_parent{
                width:90%;
                height:50vh;
                position:relative;
                overflow: scroll;
                margin:5% 5% 0 5%;
            }
            .editor_numbers{
                width:5%;
                min-height:100%;
                background-color: rgb(54, 49, 49);
                position:absolute;
                top:0;
                left:0;
            }
            .editor_numbers p{
                margin:0;
                padding:0;
                color: white;
                font-size: 15px;
                line-height: 1.5;
                text-align: center;
            }
            .editor_input{
                width:95%;
                min-height:100%;
                background-color: rgb(54, 49, 49);
                position:absolute;
                top:0;
                left:5%;
                font-size: 15px;
                line-height: 1.5;
                color: white;
                margin:0;
                padding:0;
                caret-color: white;
            }
            .editor_input:focus {
                outline: none;
            } 
            .editor_parent::-webkit-scrollbar{
                display: none;
            }
            .editor_input::selection {
                background-color: rgba(93, 186, 223, 0.664);
            }
            body::-webkit-scrollbar{
                display: none;
            
                
            }
            .box {
                width:80%;
                min-height:5%;
                padding:2%;
                margin :2% auto;
                border-left: 3px solid rgb(199, 199, 199);
                background-color: rgb(223, 223, 223);
            }
            .box p{
                margin:0;
                padding:0;
            }
            .top-content{
                width:100%;
                text-align: center;
            }
            .top-content h1 {
                width:100%;
                font-size: 3em;
                font-weight: 900;
                border-bottom: 5px solid rgb(2, 2, 77);
                margin:0;
                padding:0;
            }
            .box_parent{
                width:100%;
                border: 2px solid rgb(202, 202, 202);
                margin-top: 10%;
            }
            .kaitouran{
                width:100%;
                border: 2px solid rgb(202, 202, 202);
                margin-top: 10%;
            }
            .kaitouran h3{
                width:90%;
                margin-top: 5%;
                margin-left:auto;
                margin-right: auto;
                text-align: center;
                border-bottom: 5px solid rgb(2, 2, 77);
            }
            .exe_line{
                width:90%;
                height:10%;
                background-color: rgb(224, 224, 224);
                margin: 0 auto 5% auto;
                position:relative;
            }
            .exe_line p {
                font-weight: 400;
                margin: 0;
                padding: 0;
                display: inline;
                position: absolute;
                top:50%;
                left:20%;
                transform: translate(-50%,-50%);
            }
            .exe_line select{
                width:13%;
                height:30%;
                position: absolute;
                top:50%;
                left:44%;
                transform: translate(-50%,-50%);
                font-size: smaller;
                font-weight: 600;
            }
            .exeButton{
                width:30%;
                height:50%;
                text-align: center;
                border-radius: 5%;
                border: 1px solid rgb(18, 123, 165);
                background-color:rgb(28, 139, 184);
                color: white;
                font-size: smaller;
                position: absolute;
                top:50%;
                left:80%;
                transform: translate(-50%,-50%);
            }
            .result_parent{
                display: none;
                width:100%;
                height:30%;
                border-right: 1px solid rgb(202, 202, 202);
            }
            .result_top{
                width:100%;
                height:20%;
                margin-top: 5%;
            }
            .result_top p{
                margin:0 0 0 2%;
                padding: 0;
                color: white;
                font-size: 1.1em;
                line-height: 2;
                font-weight: 600;
            }
            .result_box{
                width:31%;
                height:80%;
                padding:1%;
                display:inline-block;
                border-left: 1px solid rgb(202, 202, 202);
                margin:0;
                vertical-align: top;
            }
            .result_box p {
                margin:0;
                padding:0;
            }
            .message{
                margin: 0;
                padding:0;
                font-weight: 600;
            }
            .exeButton2{
                width:35%;
                height:7%;
                text-align: center;
                border-radius: 5%;
                border: 1px solid rgb(18, 123, 165);
                background-color:rgb(28, 139, 184);
                color: white;
                font-size: smaller;
                margin: 5% auto;
                display: block;
            }
        </style>
        <script>
            function getParam(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }

            for (let i = 0; i < 10000; i++) {
                let textbox_element = document.getElementById('editor_numbers');
                let new_element = document.createElement('p');
                new_element.textContent = i;
                textbox_element.appendChild(new_element);
            };

            var editor = document.getElementById("editor_input");

            editor.addEventListener("keyup",(e)=>{
                var ev = editor.value;
                if(e.keyCode != "8" && ev.slice(ev.length-1,ev.length) == "\n"){
                    var a = ev.lastIndexOf("\n",ev.length);
                        if (ev.lastIndexOf("\n",a-1) != -1){
                            var tab_searth = ev.slice(ev.lastIndexOf("\n",a-1),ev.length);
                            var tab_num = 0;
                            for (let i = 0; i < ev.length; i++){
                                if (tab_searth.slice(i,i+1) == "\t"){
                                    tab_num += 1;
                                }
                            }
                            if (ev.slice(a-1,a) == ":"){
                                editor.value += "\t".repeat(tab_num +1);
                            }
                            else{
                                editor.value += "\t".repeat(tab_num);
                            }
                        }
                        else{
                            if (ev.slice(a-1,a) == ":"){
                                editor.value += "\t";
                            }
                        }
                }
            });

            editor.addEventListener("keydown", input_tab);

            function input_tab(event) {
                if (event.key === "Tab") {
                    // デフォルト動作停止
                    event.preventDefault();
                    //  Tabを挿入。範囲指定時は置換。
                    var TAB = "\t";
                    var value = this.value;
                    var sPos = this.selectionStart;
                    var ePos = this.selectionEnd;
                    var result = value.slice(0, sPos) + TAB + value.slice(ePos);
                    var cPos = sPos + TAB.length;
                    this.value = result;
                    this.setSelectionRange(cPos, cPos);
                }
            }

            function print_to_output(ev){
                for (let i = 0; i < ev.length; i++){
                        if (ev.slice(i,i+5) == "print"){
                            var a = ev.slice(0,i);
                            var b = "output";
                            var c = ev.slice(i+5,ev.lentgh);
                            ev = a+b+c;
                            
                        }
                }
                return ev;
            }
        </script>
    </body>
</html>
